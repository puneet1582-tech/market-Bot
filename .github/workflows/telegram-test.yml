name: Ultimate Brain Runner

on:
  workflow_dispatch:
  schedule:
    - cron: "30 3 * * *"

jobs:
  run-brain:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install libraries
        run: |
          python -m pip install --upgrade pip
          python -m pip install yfinance

      - name: Run Ultimate Brain and send to Telegram (split message)
        run: |
          python - <<EOF
          import os
          import subprocess
          import textwrap
          import requests

          # Run master_brain.py and capture output
          result = subprocess.run(["python", "master_brain.py"], capture_output=True, text=True)
          output = result.stdout

          token = os.environ["BOT_TOKEN"]
          chat_id = os.environ["CHAT_ID"]

          # Split message into chunks of 3500 chars (safe for Telegram)
          chunks = textwrap.wrap(output, 3500)

          for part in chunks:
              url = f"https://api.telegram.org/bot{token}/sendMessage"
              requests.post(url, data={"chat_id": chat_id, "text": part})
          EOF
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          CHAT_ID: ${{ secrets.CHAT_ID }}
